<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#1a3a6e">
<meta name="apple-mobile-web-app-title" content="생보 모의고사">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231a3a6e' width='100' height='100' rx='20'/><text x='50' y='68' font-size='50' text-anchor='middle' fill='white'>&#128221;</text></svg>">
<link rel="manifest" href="manifest.json">
<title>생명보험 모의고사</title>
<style>
:root {
  --bg: #f5f5f0;
  --paper: #ffffff;
  --text: #1a1a1a;
  --text-sub: #666;
  --border: #d0d0d0;
  --accent: #1a3a6e;
  --accent-light: #e8eef6;
  --correct: #0d6a3a;
  --correct-bg: #e6f4ed;
  --wrong: #c62828;
  --wrong-bg: #fde8e8;
  --font: 'Apple SD Gothic Neo', -apple-system, 'Malgun Gothic', sans-serif;
}
.dark {
  --bg: #1a1a1e;
  --paper: #242428;
  --text: #e8e8e8;
  --text-sub: #999;
  --border: #444;
  --accent: #6b9eff;
  --accent-light: #1e2a40;
  --correct: #4caf80;
  --correct-bg: #1a2e22;
  --wrong: #ef5350;
  --wrong-bg: #2e1a1a;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  -webkit-tap-highlight-color: transparent;
  transition: background 0.3s, color 0.3s;
}

/* ===== EXAM PAPER HEADER ===== */
.exam-header {
  background: var(--paper);
  border-bottom: 3px double var(--border);
  padding: 16px 20px 12px;
  position: sticky; top: 0; z-index: 100;
}
.exam-header-top {
  display: flex; justify-content: space-between; align-items: center;
}
.exam-title {
  font-size: 16px; font-weight: 800; letter-spacing: -0.5px;
  color: var(--accent);
}
.exam-controls {
  display: flex; gap: 8px; align-items: center;
}
.ctrl-btn {
  background: none; border: 1px solid var(--border);
  border-radius: 6px; padding: 5px 10px; font-size: 12px;
  cursor: pointer; color: var(--text-sub); font-family: var(--font);
  transition: all 0.2s;
}
.ctrl-btn:hover, .ctrl-btn.active {
  background: var(--accent); color: #fff; border-color: var(--accent);
}
.back-arrow {
  background: none; border: none; font-size: 20px;
  cursor: pointer; color: var(--accent); padding: 4px 8px 4px 0;
  display: none;
}
.exam-section-bar {
  margin-top: 8px; font-size: 12px; color: var(--text-sub);
  display: flex; justify-content: space-between; align-items: center;
}
.section-label {
  font-weight: 700; color: var(--accent);
  padding: 2px 8px; background: var(--accent-light);
  border-radius: 4px; font-size: 11px;
}
.progress-mini {
  height: 3px; background: var(--border); border-radius: 2px;
  margin-top: 6px; overflow: hidden;
}
.progress-mini-fill {
  height: 100%; background: var(--accent); border-radius: 2px;
  transition: width 0.3s;
}

/* ===== CONTAINER ===== */
.container { max-width: 600px; margin: 0 auto; padding: 0 16px; }

/* ===== HOME SCREEN ===== */
.home { padding: 20px 0 40px; }
.home-banner {
  background: var(--paper);
  border: 2px solid var(--accent);
  border-radius: 8px;
  padding: 20px; text-align: center;
  margin-bottom: 20px;
}
.home-banner h1 {
  font-size: 20px; font-weight: 800; color: var(--accent);
  margin-bottom: 4px; letter-spacing: -0.5px;
}
.home-banner p {
  font-size: 13px; color: var(--text-sub);
}
.home-banner .q-count {
  font-size: 28px; font-weight: 800; color: var(--accent);
  margin: 8px 0 2px;
}

/* Mode Toggle */
.mode-bar {
  display: flex; gap: 0; margin-bottom: 16px;
  border: 1px solid var(--border); border-radius: 8px; overflow: hidden;
}
.mode-item {
  flex: 1; padding: 10px; border: none; background: var(--paper);
  font-size: 14px; font-weight: 600; cursor: pointer;
  font-family: var(--font); color: var(--text-sub);
  border-right: 1px solid var(--border);
  transition: all 0.2s;
}
.mode-item:last-child { border-right: none; }
.mode-item.active {
  background: var(--accent); color: #fff;
}

/* Category Cards */
.cat-section { margin-bottom: 20px; }
.cat-section-title {
  font-size: 13px; font-weight: 700; color: var(--text-sub);
  text-transform: uppercase; letter-spacing: 1px;
  margin-bottom: 8px; padding-left: 2px;
}
.cat-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
}
.cat-item {
  background: var(--paper);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px;
  cursor: pointer;
  transition: all 0.15s;
}
.cat-item:active { transform: scale(0.97); }
.cat-item-title {
  font-size: 14px; font-weight: 700; margin-bottom: 2px;
  color: var(--text);
}
.cat-item-sub {
  font-size: 12px; color: var(--text-sub);
}
.cat-item-bar {
  height: 3px; background: var(--border); border-radius: 2px;
  margin-top: 8px; overflow: hidden;
}
.cat-item-bar-fill {
  height: 100%; background: var(--accent); border-radius: 2px;
}

/* Mock exam list */
.mock-list {
  display: flex; flex-direction: column; gap: 6px;
}
.mock-item {
  background: var(--paper);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px 14px;
  cursor: pointer;
  display: flex; justify-content: space-between; align-items: center;
  transition: all 0.15s;
}
.mock-item:active { transform: scale(0.98); }
.mock-item-title { font-size: 14px; font-weight: 600; }
.mock-item-info {
  font-size: 12px; color: var(--text-sub);
  display: flex; gap: 8px; align-items: center;
}
.mock-badge {
  padding: 2px 8px; border-radius: 10px; font-size: 11px;
  font-weight: 600;
}
.mock-badge.done { background: var(--correct-bg); color: var(--correct); }
.mock-badge.partial { background: var(--accent-light); color: var(--accent); }

/* Special row */
.special-row {
  display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
  margin-bottom: 20px;
}
.special-btn {
  background: var(--paper); border: 1px solid var(--border);
  border-radius: 8px; padding: 12px 8px; text-align: center;
  cursor: pointer; transition: all 0.15s;
}
.special-btn:active { transform: scale(0.97); }
.special-btn-icon { font-size: 20px; margin-bottom: 2px; }
.special-btn-label { font-size: 12px; font-weight: 600; }
.special-btn-count { font-size: 11px; color: var(--text-sub); }

/* Options */
.options-row {
  display: flex; gap: 8px; margin-bottom: 16px;
}
.opt-btn {
  padding: 6px 14px; border-radius: 16px; font-size: 12px;
  border: 1px solid var(--border); background: var(--paper);
  cursor: pointer; font-family: var(--font); color: var(--text-sub);
  transition: all 0.2s;
}
.opt-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

/* Stats */
.stats-row {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
  margin-bottom: 20px;
}
.stat-box {
  background: var(--paper); border: 1px solid var(--border);
  border-radius: 8px; padding: 12px; text-align: center;
}
.stat-num { font-size: 24px; font-weight: 800; color: var(--accent); }
.stat-label { font-size: 11px; color: var(--text-sub); margin-top: 2px; }

/* ===== QUESTION SCREEN (EXAM PAPER STYLE) ===== */
.q-screen { display: none; padding: 16px 0 100px; }
.q-paper {
  background: var(--paper);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 20px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}
.q-num-label {
  font-size: 15px; font-weight: 800; color: var(--accent);
  margin-bottom: 12px;
}
.q-text {
  font-size: 16px; font-weight: 500; line-height: 1.7;
  margin-bottom: 20px;
  word-break: keep-all;
}
.q-box {
  background: var(--accent-light);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 12px 14px;
  margin: -8px 0 20px;
  font-size: 14px; line-height: 1.6;
}

/* Choices - exam paper style */
.choice-list { display: flex; flex-direction: column; gap: 0; }
.choice-row {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 10px 12px;
  border-bottom: 1px dotted var(--border);
  cursor: pointer;
  transition: background 0.15s;
  border-radius: 4px;
}
.choice-row:last-child { border-bottom: none; }
.choice-row:hover { background: rgba(0,0,0,0.02); }
.choice-circle {
  font-size: 16px; font-weight: 500;
  min-width: 24px; flex-shrink: 0;
  color: var(--text-sub);
  padding-top: 1px;
}
.choice-content {
  font-size: 15px; line-height: 1.6;
  flex: 1; word-break: keep-all;
}

/* Study mode - correct answer bold */
.choice-row.correct-bold .choice-circle {
  color: var(--correct); font-weight: 800;
}
.choice-row.correct-bold .choice-content {
  font-weight: 700; color: var(--correct);
}

/* Practice mode - selected */
.choice-row.selected-correct {
  background: var(--correct-bg);
}
.choice-row.selected-correct .choice-circle {
  color: var(--correct); font-weight: 800;
}
.choice-row.selected-correct .choice-content {
  font-weight: 700; color: var(--correct);
}
.choice-row.selected-wrong {
  background: var(--wrong-bg);
}
.choice-row.selected-wrong .choice-circle {
  color: var(--wrong); font-weight: 800;
}
.choice-row.selected-wrong .choice-content {
  color: var(--wrong); text-decoration: line-through;
}
.choice-row.show-correct .choice-circle {
  color: var(--correct); font-weight: 800;
}
.choice-row.show-correct .choice-content {
  font-weight: 700; color: var(--correct);
}
.choice-row.disabled { pointer-events: none; }

/* Result badge */
.result-badge {
  display: none; text-align: center; margin-top: 16px;
  font-size: 15px; font-weight: 700; padding: 10px;
  border-radius: 6px;
}
.result-badge.correct { background: var(--correct-bg); color: var(--correct); }
.result-badge.wrong { background: var(--wrong-bg); color: var(--wrong); }

/* Explanation */
.explanation {
  margin-top: 16px; padding: 14px;
  border: 1px solid var(--border);
  border-left: 4px solid var(--accent);
  background: var(--accent-light);
  font-size: 14px; line-height: 1.6;
  display: none; border-radius: 0 4px 4px 0;
}
.explanation-label {
  font-weight: 700; color: var(--accent); margin-bottom: 4px;
  font-size: 13px;
}

/* Bottom Nav */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--paper);
  border-top: 2px solid var(--border);
  padding: 10px 16px; padding-bottom: max(10px, env(safe-area-inset-bottom));
  display: none; z-index: 100;
}
.bottom-nav-inner {
  max-width: 600px; margin: 0 auto;
  display: flex; justify-content: space-between; align-items: center;
}
.nav-btn {
  padding: 10px 24px; border-radius: 6px;
  border: 1px solid var(--border); font-size: 14px; font-weight: 600;
  cursor: pointer; font-family: var(--font); background: var(--paper);
  color: var(--text); transition: all 0.2s;
}
.nav-btn:active { transform: scale(0.96); }
.nav-btn.next { background: var(--accent); color: #fff; border-color: var(--accent); }
.nav-btn:disabled { opacity: 0.3; pointer-events: none; }
.nav-counter {
  font-size: 13px; font-weight: 600; color: var(--text-sub);
}

/* Exam Result */
.result-screen { display: none; padding: 40px 0; text-align: center; }
.result-score { font-size: 56px; font-weight: 800; color: var(--accent); }
.result-pass { color: var(--correct); font-size: 22px; font-weight: 700; margin: 8px 0; }
.result-fail { color: var(--wrong); font-size: 22px; font-weight: 700; margin: 8px 0; }
.result-detail { color: var(--text-sub); font-size: 14px; margin: 4px 0; }
.result-actions {
  margin-top: 24px; display: flex; gap: 12px; justify-content: center;
}
.result-btn {
  padding: 12px 24px; border-radius: 8px; font-size: 14px;
  font-weight: 600; cursor: pointer; border: 1px solid var(--border);
  font-family: var(--font); background: var(--paper); color: var(--text);
}
.result-btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }

/* Toast */
.toast {
  position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
  background: var(--text); color: var(--bg); padding: 10px 20px;
  border-radius: 20px; font-size: 13px; z-index: 200;
  opacity: 0; transition: opacity 0.3s; pointer-events: none;
}
.toast.show { opacity: 1; }

/* Loading */
.loading {
  text-align: center; padding: 60px 20px;
  color: var(--text-sub); font-size: 14px;
}
.spinner {
  width: 28px; height: 28px; border: 3px solid var(--border);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 0.8s linear infinite; margin: 0 auto 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Study mode toggle */
.toggle-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 0; margin-bottom: 8px;
}
.toggle-label { font-size: 13px; font-weight: 600; color: var(--text-sub); }
.toggle {
  width: 44px; height: 24px; border-radius: 12px;
  background: var(--border); position: relative; cursor: pointer;
  transition: background 0.2s;
}
.toggle.on { background: var(--accent); }
.toggle-knob {
  width: 20px; height: 20px; border-radius: 50%;
  background: white; position: absolute; top: 2px; left: 2px;
  transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.toggle.on .toggle-knob { transform: translateX(20px); }

.credit {
  text-align: center; font-size: 11px; color: var(--text-sub);
  padding: 20px 0;
}
</style>
</head>
<body>

<!-- Header -->
<div class="exam-header">
  <div class="exam-header-top">
    <div style="display:flex;align-items:center">
      <button class="back-arrow" id="backBtn" onclick="goBack()">&#8592;</button>
      <span class="exam-title" id="headerTitle">생명보험 모의고사</span>
    </div>
    <div class="exam-controls">
      <button class="ctrl-btn" id="bookmarkBtn" style="display:none" onclick="toggleBookmark()">&#9734;</button>
      <button class="ctrl-btn" onclick="toggleDark()">&#9790;</button>
    </div>
  </div>
  <div class="exam-section-bar" id="sectionBar" style="display:none">
    <span class="section-label" id="sectionLabel"></span>
    <span id="progressLabel"></span>
  </div>
  <div class="progress-mini" id="progressBar" style="display:none">
    <div class="progress-mini-fill" id="progressFill"></div>
  </div>
</div>

<!-- Home -->
<div id="homeScreen">
  <div class="container home">
    <div class="home-banner">
      <h1>생명보험·제3보험 모의고사</h1>
      <p>모집인 등록자격시험 문제은행 (2024~2025)</p>
      <div class="q-count" id="totalCount">0</div>
      <p>문제</p>
    </div>

    <!-- Mode -->
    <div class="mode-bar">
      <button class="mode-item active" id="modeStudy" onclick="setMode('study')">학습모드</button>
      <button class="mode-item" id="modePractice" onclick="setMode('practice')">시험모드</button>
    </div>

    <!-- Study mode panel -->
    <div id="studyPanel">
      <div class="toggle-row">
        <span class="toggle-label">정답 볼드 표시</span>
        <div class="toggle on" id="highlightToggle" onclick="toggleHighlight()">
          <div class="toggle-knob"></div>
        </div>
      </div>
      <div class="stats-row" style="grid-template-columns:1fr">
        <div class="stat-box">
          <div class="stat-num" id="statTotal">0</div>
          <div class="stat-label">전체 문제</div>
        </div>
      </div>
      <div class="special-row" style="grid-template-columns:1fr 1fr">
        <div class="special-btn" onclick="startQuiz('all_mock')">
          <div class="special-btn-icon">&#128221;</div>
          <div class="special-btn-label">전체 학습</div>
          <div class="special-btn-count" id="allCount">0</div>
        </div>
        <div class="special-btn" onclick="startQuiz('bookmarks')">
          <div class="special-btn-icon">&#9733;</div>
          <div class="special-btn-label">북마크</div>
          <div class="special-btn-count" id="bmCount">0</div>
        </div>
      </div>
    </div>

    <!-- Practice mode panel -->
    <div id="practicePanel" style="display:none">
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-num" id="statPTotal">0</div>
          <div class="stat-label">전체</div>
        </div>
        <div class="stat-box">
          <div class="stat-num" id="statDone">0</div>
          <div class="stat-label">완료</div>
        </div>
        <div class="stat-box">
          <div class="stat-num" id="statRate">-</div>
          <div class="stat-label">정답률</div>
        </div>
      </div>
      <div class="special-row">
        <div class="special-btn" onclick="startQuiz('all_mock')">
          <div class="special-btn-icon">&#128221;</div>
          <div class="special-btn-label">전체</div>
          <div class="special-btn-count" id="allCountP">0</div>
        </div>
        <div class="special-btn" onclick="startQuiz('bookmarks')">
          <div class="special-btn-icon">&#9733;</div>
          <div class="special-btn-label">북마크</div>
          <div class="special-btn-count" id="bmCountP">0</div>
        </div>
        <div class="special-btn" onclick="startQuiz('wrong')">
          <div class="special-btn-icon">&#10060;</div>
          <div class="special-btn-label">오답</div>
          <div class="special-btn-count" id="wrongCount">0</div>
        </div>
      </div>
      <div class="options-row">
        <button class="opt-btn" id="shuffleBtn" onclick="toggleShuffle()">&#128256; 셔플</button>
        <button class="opt-btn" onclick="resetProgress()">&#128260; 초기화</button>
      </div>
    </div>

    <!-- Section-based study -->
    <div class="cat-section" id="sectionStudy"></div>

    <!-- 2025 Mock Exams (Primary) -->
    <div class="cat-section" id="mockSection"></div>

    <!-- Archive (collapsible) -->
    <div class="cat-section" id="archiveSection"></div>

    <div class="credit">2025 생명보험 모의고사 기출문제 기반</div>
  </div>
</div>

<!-- Question Screen -->
<div class="q-screen" id="qScreen">
  <div class="container">
    <div class="q-paper">
      <div class="q-num-label" id="qNum"></div>
      <div class="q-text" id="qText"></div>
      <div class="q-box" id="qBox" style="display:none"></div>
      <div class="choice-list" id="choiceList"></div>
    </div>
    <div class="result-badge" id="resultBadge"></div>
    <div class="explanation" id="explanation">
      <div class="explanation-label">해설</div>
      <div id="explText"></div>
    </div>
  </div>
</div>

<!-- Result Screen -->
<div class="result-screen" id="resultScreen">
  <div class="container" id="resultContent"></div>
</div>

<!-- Bottom Nav -->
<div class="bottom-nav" id="bottomNav">
  <div class="bottom-nav-inner">
    <button class="nav-btn" id="prevBtn" onclick="prevQ()">&#9664; 이전</button>
    <span class="nav-counter" id="navCounter"></span>
    <button class="nav-btn next" id="nextBtn" onclick="nextQ()">다음 &#9654;</button>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Loading -->
<div class="loading" id="loading">
  <div class="spinner"></div>
  <div>문제 불러오는 중...</div>
</div>

<script src="data.js"></script>
<script>
// ===== STATE =====
let allQuestions = [];
let currentQuiz = [];
let currentIdx = 0;
let mode = 'study';
let showHighlight = true;
let shuffleEnabled = false;
let darkMode = false;
let answered = {};

const LS = {
  bookmarks: 'insu_bm2',
  wrong: 'insu_wr2',
  answered: 'insu_ans2',
  correct: 'insu_cor2',
  mode: 'insu_mode',
  highlight: 'insu_hl',
  shuffle: 'insu_shf',
  dark: 'insu_dk',
};

const CIRCLES = ['\u2460','\u2461','\u2462','\u2463','\u2464'];

// ===== INIT =====
function init() {
  mode = localStorage.getItem(LS.mode) || 'study';
  showHighlight = localStorage.getItem(LS.highlight) !== 'false';
  shuffleEnabled = localStorage.getItem(LS.shuffle) === 'true';
  darkMode = localStorage.getItem(LS.dark) === 'true';

  if (darkMode) document.body.classList.add('dark');
  updateModeUI();
  updateHighlightUI();
  updateShuffleUI();

  if (typeof EMBEDDED_DATA !== 'undefined') {
    allQuestions = EMBEDDED_DATA;
  }
  allQuestions.forEach((q, i) => q.id = i + 1);

  document.getElementById('loading').style.display = 'none';
  renderHome();
}

// ===== HOME =====
function getMockQs() {
  return allQuestions.filter(q => !q.archive);
}
function getArchiveQs() {
  return allQuestions.filter(q => q.archive);
}

function renderHome() {
  const saved = getSet(LS.answered);
  const correct = getSet(LS.correct);
  const bm = getSet(LS.bookmarks);
  const wrong = getSet(LS.wrong);

  const mockQs = getMockQs();
  const archiveQs = getArchiveQs();
  const mockSaved = mockQs.filter(q => saved.has(String(q.id)));
  const mockCorrect = mockQs.filter(q => correct.has(String(q.id)));

  document.getElementById('totalCount').textContent = mockQs.length;

  // Study panel
  document.getElementById('statTotal').textContent = mockQs.length;
  document.getElementById('allCount').textContent = mockQs.length + '문제';
  document.getElementById('bmCount').textContent = bm.size + '문제';

  // Practice panel
  document.getElementById('statPTotal').textContent = mockQs.length;
  document.getElementById('statDone').textContent = mockSaved.length;
  document.getElementById('statRate').textContent =
    mockSaved.length > 0 ? Math.round(mockCorrect.length / mockSaved.length * 100) + '%' : '-';
  document.getElementById('allCountP').textContent = mockQs.length + '문제';
  document.getElementById('bmCountP').textContent = bm.size + '문제';
  document.getElementById('wrongCount').textContent = wrong.size + '문제';

  // Group mock categories by year
  const cats = {};
  mockQs.forEach(q => {
    const c = q.category;
    if (!cats[c]) cats[c] = [];
    cats[c].push(q);
  });

  // Section-based study (보험이론, 보험법규, 생명보험, 제3보험)
  const sections = {};
  mockQs.forEach(q => {
    const s = q.section || '기타';
    if (!sections[s]) sections[s] = [];
    sections[s].push(q);
  });
  const sectionOrder = ['보험이론 및 윤리', '보험법규', '생명보험', '제3보험'];
  let secHtml = '<div class="cat-section-title">영역별 학습</div>';
  secHtml += '<div class="cat-grid">';
  sectionOrder.forEach(s => {
    const qs = sections[s] || [];
    if (qs.length === 0) return;
    const done = qs.filter(q => saved.has(String(q.id))).length;
    const pct = qs.length > 0 ? Math.round(done / qs.length * 100) : 0;
    secHtml += `<div class="cat-item" onclick="startQuiz('section:${s}')">
      <div class="cat-item-title">${s}</div>
      <div class="cat-item-sub">${qs.length}문제${done > 0 ? ' · ' + pct + '%' : ''}</div>
      <div class="cat-item-bar"><div class="cat-item-bar-fill" style="width:${pct}%"></div></div>
    </div>`;
  });
  secHtml += '</div>';
  document.getElementById('sectionStudy').innerHTML = secHtml;

  // Separate by year
  const years = {};
  Object.keys(cats).sort().forEach(c => {
    const ym = c.match(/^(\d{4})년/);
    const year = ym ? ym[1] : '기타';
    if (!years[year]) years[year] = [];
    years[year].push(c);
  });

  // Render mock exams by year (newest first)
  let mockHtml = '';
  Object.keys(years).sort().reverse().forEach(year => {
    const yearCats = years[year];
    const yearQs = yearCats.flatMap(c => cats[c]);
    const yearDone = yearQs.filter(q => saved.has(String(q.id))).length;
    const yearPct = yearQs.length > 0 ? Math.round(yearDone / yearQs.length * 100) : 0;

    mockHtml += `<div class="cat-section-title">${year}년 모의고사 (${yearCats.length}회 · ${yearQs.length}문제${yearDone > 0 ? ' · ' + yearPct + '%' : ''})</div>`;
    mockHtml += '<div class="mock-list">';

    yearCats.forEach(c => {
      const qs = cats[c];
      const done = qs.filter(q => saved.has(String(q.id))).length;
      const pct = qs.length > 0 ? Math.round(done / qs.length * 100) : 0;
      let badge = '';
      if (pct === 100) badge = '<span class="mock-badge done">완료</span>';
      else if (done > 0) badge = `<span class="mock-badge partial">${pct}%</span>`;

      mockHtml += `<div class="mock-item" onclick="startQuiz('cat:${c}')">
        <div class="mock-item-title">${c.replace(year + '년 ', '')}</div>
        <div class="mock-item-info">
          <span>${qs.length}문제</span>
          ${badge}
        </div>
      </div>`;
    });
    mockHtml += '</div>';
  });
  document.getElementById('mockSection').innerHTML = mockHtml;

  // Render archive (collapsible)
  if (archiveQs.length > 0) {
    const archiveCats = {};
    archiveQs.forEach(q => {
      const c = q.category;
      if (!archiveCats[c]) archiveCats[c] = [];
      archiveCats[c].push(q);
    });

    let arcHtml = `<div class="cat-section-title" style="cursor:pointer;display:flex;align-items:center;gap:6px" onclick="toggleArchive()">
      <span id="archiveArrow" style="transition:transform 0.2s;display:inline-block">&#9654;</span>
      아카이브 (유튜브 강의 자료 · ${archiveQs.length}문제)
    </div>`;
    arcHtml += '<div class="mock-list" id="archiveList" style="display:none">';
    arcHtml += `<div style="font-size:12px;color:var(--text-sub);padding:8px 0;line-height:1.5">
      유튜브 강의에서 추출한 보충 자료입니다.<br>실제 시험과 형식이 다를 수 있습니다.
    </div>`;

    Object.keys(archiveCats).sort().forEach(c => {
      const qs = archiveCats[c];
      const done = qs.filter(q => saved.has(String(q.id))).length;
      const pct = qs.length > 0 ? Math.round(done / qs.length * 100) : 0;
      let badge = '';
      if (pct === 100) badge = '<span class="mock-badge done">완료</span>';
      else if (done > 0) badge = `<span class="mock-badge partial">${pct}%</span>`;

      arcHtml += `<div class="mock-item" onclick="startQuiz('cat:${c}')">
        <div class="mock-item-title">${c}</div>
        <div class="mock-item-info">
          <span>${qs.length}문제</span>
          ${badge}
        </div>
      </div>`;
    });
    arcHtml += '</div>';
    document.getElementById('archiveSection').innerHTML = arcHtml;
  }
}

// ===== ARCHIVE TOGGLE =====
function toggleArchive() {
  const list = document.getElementById('archiveList');
  const arrow = document.getElementById('archiveArrow');
  if (list.style.display === 'none') {
    list.style.display = 'flex';
    arrow.style.transform = 'rotate(90deg)';
  } else {
    list.style.display = 'none';
    arrow.style.transform = 'rotate(0deg)';
  }
}

// ===== QUIZ =====
function startQuiz(filter) {
  let qs = [];
  if (filter === 'all_mock') qs = getMockQs();
  else if (filter === 'all') qs = [...allQuestions];
  else if (filter === 'bookmarks') {
    const bm = getSet(LS.bookmarks);
    qs = allQuestions.filter(q => bm.has(String(q.id)));
  } else if (filter === 'wrong') {
    const wr = getSet(LS.wrong);
    qs = allQuestions.filter(q => wr.has(String(q.id)));
  } else if (filter.startsWith('section:')) {
    const sec = filter.substring(8);
    qs = getMockQs().filter(q => q.section === sec);
  } else if (filter.startsWith('cat:')) {
    qs = allQuestions.filter(q => q.category === filter.substring(4));
  } else if (filter.startsWith('cat_prefix:')) {
    const pfx = filter.substring(11);
    qs = allQuestions.filter(q => q.category.startsWith(pfx));
  }

  if (qs.length === 0) { showToast('문제가 없습니다'); return; }
  if (shuffleEnabled) qs = shuffle(qs);

  currentQuiz = qs;
  currentIdx = 0;
  answered = {};

  document.getElementById('homeScreen').style.display = 'none';
  document.getElementById('qScreen').style.display = 'block';
  document.getElementById('resultScreen').style.display = 'none';
  document.getElementById('bottomNav').style.display = 'block';
  document.getElementById('backBtn').style.display = 'inline';
  document.getElementById('bookmarkBtn').style.display = 'inline';
  document.getElementById('sectionBar').style.display = 'flex';
  document.getElementById('progressBar').style.display = 'block';

  renderQ();
}

function renderQ() {
  if (currentIdx >= currentQuiz.length) { showResult(); return; }

  const q = currentQuiz[currentIdx];
  const section = q.section || q.category;

  // Header
  document.getElementById('headerTitle').textContent = q.category;
  document.getElementById('sectionLabel').textContent = section;
  const pct = ((currentIdx + 1) / currentQuiz.length * 100).toFixed(0);
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressLabel').textContent = `${currentIdx + 1} / ${currentQuiz.length}`;

  // Question number
  const srcNum = q.source_q_num || (currentIdx + 1);
  document.getElementById('qNum').textContent = `${srcNum}.`;

  // Question text - check if there's a box/table content
  const qText = q.question;
  document.getElementById('qText').textContent = qText;
  document.getElementById('qBox').style.display = 'none';

  // Bookmark
  const bm = getSet(LS.bookmarks);
  document.getElementById('bookmarkBtn').innerHTML = bm.has(String(q.id)) ? '&#9733;' : '&#9734;';

  // Choices
  const list = document.getElementById('choiceList');
  let html = '';
  q.choices.forEach((c, i) => {
    const num = i + 1;
    let cls = '';

    if (mode === 'study' && showHighlight && num === q.answer) {
      cls = 'correct-bold';
    }

    if (mode === 'practice' && answered[q.id] !== undefined) {
      const sel = answered[q.id];
      if (num === q.answer) {
        cls = sel === num ? 'selected-correct' : 'show-correct';
      } else if (num === sel) {
        cls = 'selected-wrong';
      }
      cls += ' disabled';
    }

    html += `<div class="choice-row ${cls}" onclick="selectChoice(${q.id},${num})">
      <span class="choice-circle">${CIRCLES[i]}</span>
      <span class="choice-content">${esc(c)}</span>
    </div>`;
  });
  list.innerHTML = html;

  // Result badge
  const badge = document.getElementById('resultBadge');
  badge.style.display = 'none';
  if (mode === 'practice' && answered[q.id] !== undefined) {
    badge.style.display = 'block';
    if (answered[q.id] === q.answer) {
      badge.className = 'result-badge correct';
      badge.textContent = '정답!';
    } else {
      badge.className = 'result-badge wrong';
      badge.textContent = '오답 (정답: ' + CIRCLES[q.answer - 1] + ')';
    }
  }

  // Explanation
  const explEl = document.getElementById('explanation');
  const explText = document.getElementById('explText');
  if (mode === 'study' || (mode === 'practice' && answered[q.id] !== undefined)) {
    if (q.explanation && q.explanation.trim()) {
      explEl.style.display = 'block';
      explText.textContent = q.explanation;
    } else {
      explEl.style.display = 'none';
    }
  } else {
    explEl.style.display = 'none';
  }

  // Nav
  document.getElementById('prevBtn').disabled = currentIdx === 0;
  document.getElementById('navCounter').textContent =
    mode === 'practice' ? `${Object.keys(answered).length}/${currentQuiz.length}` : '';

  window.scrollTo(0, 0);
}

function selectChoice(qid, choice) {
  if (mode === 'study') return;
  if (answered[qid] !== undefined) return;

  const q = currentQuiz[currentIdx];
  answered[qid] = choice;

  addToSet(LS.answered, String(qid));
  if (choice === q.answer) {
    addToSet(LS.correct, String(qid));
    removeFromSet(LS.wrong, String(qid));
  } else {
    addToSet(LS.wrong, String(qid));
    removeFromSet(LS.correct, String(qid));
  }
  renderQ();
}

function nextQ() {
  if (currentIdx < currentQuiz.length - 1) { currentIdx++; renderQ(); }
  else if (mode === 'practice') showResult();
}
function prevQ() {
  if (currentIdx > 0) { currentIdx--; renderQ(); }
}

// ===== RESULT =====
function showResult() {
  if (mode !== 'practice') { goHome(); return; }

  const total = currentQuiz.length;
  let correct = 0;
  currentQuiz.forEach(q => { if (answered[q.id] === q.answer) correct++; });
  const score = total > 0 ? Math.round(correct / total * 100) : 0;
  const pass = score >= 60;

  document.getElementById('qScreen').style.display = 'none';
  document.getElementById('resultScreen').style.display = 'block';
  document.getElementById('bottomNav').style.display = 'none';
  document.getElementById('sectionBar').style.display = 'none';
  document.getElementById('progressBar').style.display = 'none';

  document.getElementById('resultContent').innerHTML = `
    <div style="margin-top:20px">
      <div class="result-score">${score}점</div>
      <div class="${pass ? 'result-pass' : 'result-fail'}">
        ${pass ? '합격' : '불합격'}
      </div>
      <div class="result-detail">${correct}/${total} 정답 (합격 기준: 60점)</div>
      <div class="result-detail">오답: ${total - correct}문제</div>
      <div class="result-actions">
        <button class="result-btn" onclick="startQuiz('wrong')">오답 다시 풀기</button>
        <button class="result-btn primary" onclick="goHome()">홈으로</button>
      </div>
    </div>`;
}

// ===== NAV =====
function goBack() { goHome(); }
function goHome() {
  document.getElementById('homeScreen').style.display = 'block';
  document.getElementById('qScreen').style.display = 'none';
  document.getElementById('resultScreen').style.display = 'none';
  document.getElementById('bottomNav').style.display = 'none';
  document.getElementById('backBtn').style.display = 'none';
  document.getElementById('bookmarkBtn').style.display = 'none';
  document.getElementById('sectionBar').style.display = 'none';
  document.getElementById('progressBar').style.display = 'none';
  document.getElementById('headerTitle').textContent = '생명보험 모의고사';
  renderHome();
}

// ===== SETTINGS =====
function setMode(m) {
  mode = m; localStorage.setItem(LS.mode, m);
  updateModeUI();
  renderHome();
}
function updateModeUI() {
  document.getElementById('modeStudy').className = 'mode-item' + (mode === 'study' ? ' active' : '');
  document.getElementById('modePractice').className = 'mode-item' + (mode === 'practice' ? ' active' : '');
  document.getElementById('studyPanel').style.display = mode === 'study' ? 'block' : 'none';
  document.getElementById('practicePanel').style.display = mode === 'practice' ? 'block' : 'none';
}
function toggleHighlight() {
  showHighlight = !showHighlight;
  localStorage.setItem(LS.highlight, showHighlight);
  updateHighlightUI();
}
function updateHighlightUI() {
  document.getElementById('highlightToggle').className = 'toggle' + (showHighlight ? ' on' : '');
}
function toggleShuffle() {
  shuffleEnabled = !shuffleEnabled;
  localStorage.setItem(LS.shuffle, shuffleEnabled);
  updateShuffleUI();
}
function updateShuffleUI() {
  document.getElementById('shuffleBtn').className = 'opt-btn' + (shuffleEnabled ? ' active' : '');
}
function toggleDark() {
  darkMode = !darkMode;
  document.body.classList.toggle('dark', darkMode);
  localStorage.setItem(LS.dark, darkMode);
}
function toggleBookmark() {
  if (!currentQuiz.length) return;
  const q = currentQuiz[currentIdx];
  const bm = getSet(LS.bookmarks);
  if (bm.has(String(q.id))) {
    removeFromSet(LS.bookmarks, String(q.id));
    showToast('북마크 해제');
  } else {
    addToSet(LS.bookmarks, String(q.id));
    showToast('북마크 추가');
  }
  document.getElementById('bookmarkBtn').innerHTML =
    getSet(LS.bookmarks).has(String(q.id)) ? '&#9733;' : '&#9734;';
}
function resetProgress() {
  if (!confirm('모든 진행 상황을 초기화하시겠습니까?')) return;
  localStorage.removeItem(LS.answered);
  localStorage.removeItem(LS.correct);
  localStorage.removeItem(LS.wrong);
  localStorage.removeItem(LS.bookmarks);
  showToast('초기화 완료');
  renderHome();
}

// ===== UTILS =====
function getSet(k) {
  try { return new Set(JSON.parse(localStorage.getItem(k) || '[]')); }
  catch { return new Set(); }
}
function saveSet(k, s) { localStorage.setItem(k, JSON.stringify([...s])); }
function addToSet(k, v) { const s = getSet(k); s.add(v); saveSet(k, s); }
function removeFromSet(k, v) { const s = getSet(k); s.delete(v); saveSet(k, s); }
function shuffle(a) {
  const r = [...a];
  for (let i = r.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [r[i], r[j]] = [r[j], r[i]];
  }
  return r;
}
function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 1500);
}

// Swipe
let tx = 0;
document.addEventListener('touchstart', e => { tx = e.touches[0].clientX; });
document.addEventListener('touchend', e => {
  if (document.getElementById('qScreen').style.display !== 'block') return;
  const d = e.changedTouches[0].clientX - tx;
  if (Math.abs(d) > 80) { d > 0 ? prevQ() : nextQ(); }
});

// Keyboard
document.addEventListener('keydown', e => {
  if (document.getElementById('qScreen').style.display !== 'block') return;
  if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextQ(); }
  if (e.key === 'ArrowLeft') { e.preventDefault(); prevQ(); }
  if (e.key >= '1' && e.key <= '5' && mode === 'practice') {
    const q = currentQuiz[currentIdx];
    if (q) selectChoice(q.id, parseInt(e.key));
  }
});

init();
</script>
</body>
</html>
